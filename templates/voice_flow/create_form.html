{% extends "base.html" %}

{% block title %}Create Voice Form - VoiceGen{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Create a Voice Form</h1>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left: Form details and fields -->
        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow">
            <div class="mb-6 p-4 border-2 border-dashed rounded bg-gray-50">
                <h2 class="text-lg font-semibold mb-2">Describe your form</h2>
                <p class="text-sm text-gray-600 mb-2">Write what this form should do and the information to collect. We'll generate the schema and fields for you.</p>
                <textarea id="form-desc" class="mt-1 w-full border rounded px-3 py-2" rows="3" placeholder="Example: Create a job application form to collect full name, email, years of experience (number), and optional portfolio URL."></textarea>
                <div class="mt-3 flex items-center space-x-3">
                    <button id="btn-generate-schema" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Generate from description</button>
                    <span id="gen-status" class="text-sm text-gray-600"></span>
                </div>
                <div id="clarifications" class="mt-3 text-sm text-amber-700"></div>
            </div>
            <!-- API key inputs removed: session-based auth is used for API access -->
            <h2 class="text-xl font-semibold mb-4">Form Details</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Form Name</label>
                    <input id="form-name" type="text" class="mt-1 w-full border rounded px-3 py-2" placeholder="Customer Feedback" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="form-description" class="mt-1 w-full border rounded px-3 py-2" rows="2" placeholder="Collect customer feedback"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Initial AI Greeting</label>
                    <input id="ai-prompt" type="text" class="mt-1 w-full border rounded px-3 py-2" placeholder="Hello! I'd love to get your feedback." />
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Success Message</label>
                        <input id="success-message" type="text" class="mt-1 w-full border rounded px-3 py-2" placeholder="Thank you for your feedback!" />
                    </div>
                </div>
            </div>

            <h2 class="text-xl font-semibold mt-8 mb-4">Fields</h2>
            <div id="fields-list" class="space-y-4"></div>

            <div class="mt-4 flex items-center space-x-3">
                <button id="add-field" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded">Add Field</button>
                <button id="save-form" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Save Form</button>
                <span id="save-status" class="text-sm text-gray-600"></span>
            </div>
        </div>

        <!-- Right: Field types and JSON preview -->
        <div class="bg-white p-6 rounded-lg shadow space-y-6">
            <div>
                <h3 class="text-lg font-semibold mb-2">Field Types</h3>
                <ul class="list-disc list-inside text-gray-700 space-y-1">
                    <li><strong>text</strong>: min_length, max_length, pattern</li>
                    <li><strong>number</strong>: min, max, integer_only</li>
                    <li><strong>email</strong>: domain_whitelist</li>
                    <li><strong>phone</strong>: country_code, format</li>
                    <li><strong>date</strong>: min_date, max_date</li>
                    <li><strong>boolean</strong></li>
                    <li><strong>choice</strong>: options</li>
                    <li><strong>multi_choice</strong>: options, min_choices, max_choices</li>
                </ul>
            </div>
            <div>
                <h3 class="text-lg font-semibold mb-2">JSON Preview</h3>
                <pre id="json-preview" class="bg-gray-900 text-gray-100 p-3 rounded text-sm overflow-x-auto">{}</pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Minimal client-side builder for fields and JSON preview
(function() {
    const fieldsList = document.getElementById('fields-list');
    const jsonPreview = document.getElementById('json-preview');
    const addFieldBtn = document.getElementById('add-field');
    const saveBtn = document.getElementById('save-form');
    const saveStatus = document.getElementById('save-status');
    const generateBtn = document.getElementById('btn-generate-schema');
    const genStatus = document.getElementById('gen-status');
    const clarificationsEl = document.getElementById('clarifications');

    const apiBase = '/api/forms/';
    // Using session auth; no dev API key endpoint needed
    function getCsrfToken() {
        try {
            return document.cookie.split('; ').find(r => r.startsWith('csrftoken='))?.split('=')[1] || '';
        } catch (e) { return ''; }
    }
    const genSchemaUrl = '/api/generate-form-schema/';

    function newFieldRow() {
        const wrapper = document.createElement('div');
        wrapper.className = 'border rounded p-4';
        wrapper.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700">Field Name</label>
                    <input type="text" class="field-name mt-1 w-full border rounded px-3 py-2" placeholder="customer_name" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Type</label>
                    <select class="field-type mt-1 w-full border rounded px-3 py-2">
                        <option value="text">text</option>
                        <option value="number">number</option>
                        <option value="email">email</option>
                        <option value="phone">phone</option>
                        <option value="date">date</option>
                        <option value="boolean">boolean</option>
                        <option value="choice">choice</option>
                        <option value="multi_choice">multi_choice</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Required</label>
                    <select class="field-required mt-1 w-full border rounded px-3 py-2">
                        <option value="true">true</option>
                        <option value="false">false</option>
                    </select>
                </div>
                <div class="md:col-span-5">
                    <label class="block text-sm font-medium text-gray-700">Prompt</label>
                    <input type="text" class="field-prompt mt-1 w-full border rounded px-3 py-2" placeholder="What is your name?" />
                </div>
            </div>
            <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Validation (JSON)</label>
                    <input type="text" class="field-validation mt-1 w-full border rounded px-3 py-2" placeholder='{"min":1,"max":10} or {"options":["A","B"]}' />
                </div>
                <div class="flex items-end justify-between">
                    <button type="button" class="remove-field text-red-600 hover:underline">Remove</button>
                </div>
            </div>
        `;

        wrapper.querySelector('.remove-field').addEventListener('click', () => {
            wrapper.remove();
            renderPreview();
        });

        ['field-name','field-type','field-required','field-prompt','field-validation'].forEach(cls => {
            wrapper.querySelector(`.${cls}`).addEventListener('input', renderPreview);
            wrapper.querySelector(`.${cls}`).addEventListener('change', renderPreview);
        });

        return wrapper;
    }

    function newFieldRowPrefilled(field) {
        const row = newFieldRow();
        if (field) {
            row.querySelector('.field-name').value = field.name || '';
            row.querySelector('.field-type').value = field.type || 'text';
            row.querySelector('.field-required').value = String(!!field.required);
            row.querySelector('.field-prompt').value = field.prompt || '';
            if (field.validation && Object.keys(field.validation).length) {
                row.querySelector('.field-validation').value = JSON.stringify(field.validation);
            }
        }
        return row;
    }

    function collectConfig() {
        const fields = Array.from(fieldsList.children).map(row => {
            const name = row.querySelector('.field-name').value.trim();
            const type = row.querySelector('.field-type').value;
            const required = row.querySelector('.field-required').value === 'true';
            const prompt = row.querySelector('.field-prompt').value.trim();
            const validationRaw = row.querySelector('.field-validation').value.trim();
            let validation;
            if (validationRaw) {
                try { validation = JSON.parse(validationRaw); } catch(e) { validation = undefined; }
            }
            const f = { name, type, required, prompt };
            if (validation && Object.keys(validation).length) f.validation = validation;
            return f;
        });

        return {
            name: document.getElementById('form-name').value.trim(),
            description: document.getElementById('form-description').value.trim(),
            fields,
            ai_prompt: document.getElementById('ai-prompt').value.trim(),
            success_message: document.getElementById('success-message').value.trim()
        };
    }

    function renderPreview() {
        const cfg = collectConfig();
        jsonPreview.textContent = JSON.stringify(cfg, null, 2);
    }

    addFieldBtn.addEventListener('click', () => {
        fieldsList.appendChild(newFieldRow());
        renderPreview();
    });

    // Start with one field
    fieldsList.appendChild(newFieldRow());
    renderPreview();

    function applyGeneratedSchema(schema) {
        if (!schema) return;
        const nameEl = document.getElementById('form-name');
        const descEl = document.getElementById('form-description');
        const aiEl = document.getElementById('ai-prompt');
        if (schema.name) nameEl.value = schema.name;
        if (schema.description) descEl.value = schema.description;
        if (schema.ai_prompt) aiEl.value = schema.ai_prompt;
        // Replace fields with generated
        fieldsList.innerHTML = '';
        (schema.fields || []).forEach(f => fieldsList.appendChild(newFieldRowPrefilled(f)));
        renderPreview();
    }

    async function generateFromDescription() {
        clarificationsEl.textContent = '';
        genStatus.textContent = 'Generating...';
        try {
            const formDesc = document.getElementById('form-desc').value.trim();
            if (!formDesc) { genStatus.textContent = 'Enter a description first.'; return; }
            const res = await fetch(genSchemaUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                credentials: 'same-origin',
                body: JSON.stringify({ formDesc })
            });
            if (!res.ok) {
                const txt = await res.text();
                throw new Error(txt || `HTTP ${res.status}`);
            }
            const data = await res.json();
            applyGeneratedSchema(data.schema);
            const qs = data.clarifying_questions || [];
            if (qs.length) {
                clarificationsEl.innerHTML = '<strong>Clarifying questions:</strong><ul class="list-disc list-inside">' + qs.map(q => `<li>${q}</li>`).join('') + '</ul>';
            }
            genStatus.textContent = '✅ Generated';
        } catch (e) {
            console.error(e);
            genStatus.textContent = '❌ Failed to generate';
        }
    }

    generateBtn.addEventListener('click', generateFromDescription);

    async function saveForm() {
        saveStatus.textContent = 'Saving...';
        const cfg = collectConfig();
        try {
            const res = await fetch(apiBase, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                credentials: 'same-origin',
                body: JSON.stringify(cfg)
            });
            if (!res.ok) {
                const txt = await res.text();
                throw new Error(txt || `HTTP ${res.status}`);
            }
            const data = await res.json();
            saveStatus.textContent = `✅ Created! Form ID: ${data.form_id}`;
            if (data.magic_link) {
                saveStatus.textContent += ` | Magic Link: ${data.magic_link}`;
            }
        } catch (e) {
            console.error(e);
            saveStatus.textContent = '❌ Failed to save form';
        }
    }

    saveBtn.addEventListener('click', saveForm);

    // API key validation/creation UI removed
})();
</script>
{% endblock %}


